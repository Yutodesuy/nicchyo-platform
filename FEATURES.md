# nicchyo 日曜市マップ - 機能一覧

**バージョン**: 1.0.0
**最終更新**: 2025年12月28日

---

## 📱 アプリケーション概要

高知市の日曜市を楽しむための総合プラットフォーム。300店舗の情報を地図上で確認し、検索・お気に入り・買い物リスト管理などの機能を提供します。

---

## 🗺️ 1. マップ機能（メイン機能）

### 1.1 店舗マップ表示
- **300店舗のマーカー表示**
  - 店舗イラストと商品吹き出しによる視覚的表示
  - カテゴリー別の色分け（食材、食べ物、道具・工具、生活雑貨、植物・苗、アクセサリー、手作り・工芸）
  - 選択店舗のハイライト表示

- **クラスタリング機能** 🆕
  - ズームアウト時に近接店舗をグループ化（300マーカー → 10-20クラスター）
  - クラスタサイズに応じた視覚表示（小・中・大）
  - パフォーマンス最適化（Canvas レンダリング）

- **2段階ズーム表示**
  - 遠距離ビュー（ズーム14-16）: 道路のみ表示
  - 近距離ビュー（ズーム17-19）: 店舗マーカー + 道路表示

- **インタラクティブ操作**
  - マーカークリックで店舗詳細表示
  - ドラッグ＆ズームで自由な地図操作
  - ユーザー位置表示

### 1.2 店舗詳細表示
- **基本情報**
  - 店舗名、ブロック番号
  - 取扱商品リスト
  - カテゴリー

- **アクション**
  - お気に入り登録/解除
  - 商品をバッグに追加
  - コトヅテ（メモ・いいね）

### 1.3 AIエージェントアシスタント
- **買い物プラン生成**
  - 自然言語での要望入力
  - AI による最適な店舗ルート提案
  - プラン内の店舗を地図上で番号表示（①②③...）

- **会話履歴管理**
  - 過去のプラン保存
  - プラン再表示機能

### 1.4 おせっかいばあちゃん機能
- **自動コメント表示**
  - 日曜市に関する豆知識・アドバイス
  - 60秒ごとに自動ローテーション
  - タップで次のコメントへ切り替え

- **コメント内容**
  - 日曜市の歴史
  - おすすめの時間帯
  - 地元の文化紹介

### 1.5 レシピ提案機能
- **日替わりレシピバナー**
  - 日曜市の食材を使ったレシピ提案
  - レシピ詳細表示（材料・作り方）
  - バナー表示/非表示設定

---

## 🔍 2. 検索機能

### 2.1 高速全文検索
- **300店舗の即座検索**
  - テキスト検索（店舗名・商品名・カテゴリー）
  - 検索インデックスによる高速検索
  - リアルタイム結果表示

### 2.2 フィルター機能
- **カテゴリーフィルター**
  - 7つのカテゴリー（食材、食べ物、道具・工具、生活雑貨、植物・苗、アクセサリー、手作り・工芸）
  - ワンタップでカテゴリー絞り込み

- **ブロック番号検索**
  - 丁目単位での店舗検索
  - 特定エリアの店舗を素早く発見

### 2.3 検索結果表示
- **店舗カード一覧**
  - 店舗名、ブロック番号、カテゴリー
  - 取扱商品プレビュー
  - お気に入り状態表示

- **マップ連携**
  - 「マップで見る」ボタン
  - 検索結果を地図上でハイライト表示
  - 検索ラベルの保持

---

## ⭐ 3. お気に入り機能

### 3.1 お気に入り店舗管理
- **登録/解除**
  - ワンタップでお気に入り登録
  - ハートアイコンによる視覚的表示
  - localStorage による永続化

- **お気に入り表示**
  - 地図上でハートマーカー表示
  - 検索結果でハイライト表示

- **データ同期**
  - CustomEvent による状態同期
  - 複数タブ間でのリアルタイム同期

---

## 🛍️ 4. バッグ（買い物リスト）機能

### 4.1 買い物リスト管理
- **アイテム追加**
  - 店舗から直接商品追加
  - 手動でアイテム追加
  - カテゴリー・数量・メモの記録

- **アイテム編集**
  - 数量変更
  - メモ追加
  - 写真添付（将来機能）

- **アイテム削除**
  - スワイプで削除
  - 一括クリア機能

### 4.2 パフォーマンス最適化 🆕
- **localStorage 最適化**
  - メモリキャッシュによる高速アクセス
  - デバウンス書き込み（500ms）
  - アクセス回数 80%削減（29回 → 5-10回）

---

## 🏆 5. バッジ機能

### 5.1 時間帯バッジ
- **30分単位の来訪記録**
  - 日曜 5:00 〜 17:00 の24時間帯
  - 緑（訪問済み）/ 灰色（未訪問）のゲージ表示
  - 訪問時刻の自動記録

- **バッジ獲得条件**
  - 早朝バッジ（5:00-7:00）
  - 午前バッジ（7:00-12:00）
  - 午後バッジ（12:00-17:00）
  - コンプリートバッジ（全時間帯制覇）

### 5.2 ショッピングバッジ
- **購入店舗数に応じたバッジ**
  - 初めての買い物（1店舗）
  - お気に入りを見つけた（5店舗）
  - 日曜市マスター（10店舗）
  - コンプリートコレクター（20店舗以上）

### 5.3 コトヅテバッジ
- **メモ・いいね数に応じたバッジ**
  - メモバッジ（1個、5個、10個、20個以上）
  - いいねバッジ（1個、5個、10個、20個以上）

### 5.4 バッジ一覧表示
- **獲得状況の可視化**
  - 獲得済み/未獲得の区別
  - 進捗率表示
  - 次の目標の提示

---

## 📝 6. コトヅテ機能

### 6.1 店舗メモ
- **自由記述メモ**
  - 店舗ごとのメモ作成
  - 訪問時の感想・メモを記録
  - 編集・削除機能

### 6.2 いいね機能
- **ワンタップでいいね**
  - 気に入った店舗に「いいね」
  - いいね数のカウント
  - いいね店舗の管理

---

## 🍳 7. レシピ機能

### 7.1 レシピ一覧
- **日曜市食材レシピ**
  - 地元食材を使ったレシピ集
  - カテゴリー別表示
  - サムネイル画像付き

### 7.2 レシピ詳細
- **材料・作り方**
  - 必要な材料リスト
  - 手順ごとの詳しい説明
  - 調理時間の目安

### 7.3 日替わりレシピ提案
- **マップページでの提案**
  - 毎日異なるレシピを自動選択
  - バナー表示/非表示切り替え
  - レシピ詳細へのリンク

---

## 👤 8. ユーザー機能

### 8.1 認証機能
- **ログイン/ログアウト**
  - JWT トークンベースの認証
  - セッション管理
  - ユーザー名表示

### 8.2 ユーザープロフィール
- **プロフィール表示**
  - ユーザー名
  - バッジ獲得状況
  - お気に入り店舗数

---

## 📄 9. 情報ページ

### 9.1 イベント情報
- **日曜市イベント**
  - 特別イベント情報
  - 季節のお知らせ

### 9.2 FAQ
- **よくある質問**
  - 日曜市について
  - アプリの使い方
  - トラブルシューティング

### 9.3 お問い合わせ
- **問い合わせフォーム**
  - 質問・要望の送信
  - バグ報告

### 9.4 About
- **アプリについて**
  - 開発者情報
  - バージョン情報
  - 利用規約

---

## 🎨 10. UI/UX 機能

### 10.1 レスポンシブデザイン
- **モバイルファースト**
  - スマートフォン最適化
  - タブレット対応
  - デスクトップ表示対応

### 10.2 ナビゲーション
- **ボトムナビゲーションバー**
  - ホーム
  - マップ
  - 検索
  - バッグ
  - マイページ

### 10.3 テーマ・スタイル
- **暖色系デザイン**
  - アンバー・オレンジ・イエローのグラデーション
  - 日曜市の温かみのある雰囲気
  - 視認性の高い配色

---

## ⚡ 11. パフォーマンス最適化 🆕

### 11.1 マップ最適化
- **Canvas ベースレンダリング**
  - DOM 要素数の大幅削減（1800+ → 30要素）
  - 初回レンダリング時間 60-70%削減

- **マーカークラスタリング**
  - leaflet.markercluster による最適化
  - ズームレベルに応じた自動グループ化

- **React.memo によるメモ化**
  - 不要な再レンダリング防止
  - renderToStaticMarkup 実行の最適化（50-70%削減）

### 11.2 データ最適化
- **localStorage 最適化**
  - Context API によるメモリキャッシュ
  - デバウンス書き込み（500ms）
  - アクセス回数 80%削減

### 11.3 コード分割
- **遅延ロード**
  - HamburgerMenu の dynamic import
  - 初回バンドルサイズ 30-50KB削減
  - マップコンポーネントの SSR 無効化

### 11.4 画像最適化
- **Next.js Image 最適化**
  - WebP/AVIF フォーマット対応
  - レスポンシブ画像サイズ
  - 自動キャッシュ（60秒 TTL）

---

## 🔒 12. セキュリティ機能 🆕

### 12.1 セキュリティヘッダー
- **X-Frame-Options**: SAMEORIGIN
- **X-Content-Type-Options**: nosniff
- **Referrer-Policy**: origin-when-cross-origin
- **X-DNS-Prefetch-Control**: on

### 12.2 依存関係セキュリティ
- **脆弱性修正**
  - glob 脆弱性修正（High）
  - ESLint 9 アップグレード
  - 定期的な依存関係更新

---

## 📦 13. データ構造

### 13.1 店舗データ
```typescript
interface Shop {
  id: number;
  name: string;
  lat: number;
  lng: number;
  category: string;
  icon: string;
  products: string[];
  blockNumber?: string;
  illustration?: {
    type: 'tent' | 'stall' | 'booth';
    size: 'small' | 'medium' | 'large';
    color?: string;
    customSvg?: string;
  };
  side?: 'left' | 'right';
}
```

### 13.2 バッグアイテム
```typescript
interface BagItem {
  id: string;
  name: string;
  fromShopId?: number;
  category?: string;
  qty?: string;
  note?: string;
  photo?: string;
  createdAt: number;
}
```

---

## 🛠️ 14. 技術スタック

### フロントエンド
- **Next.js 16.1.1** - React フレームワーク
- **React 18.3.1** - UI ライブラリ
- **TypeScript 5.9.3** - 型安全性
- **Tailwind CSS 3.4.4** - スタイリング
- **Framer Motion** - アニメーション

### マップ
- **Leaflet 1.9.4** - 地図ライブラリ
- **React Leaflet 4.2.1** - React統合
- **leaflet.markercluster 1.5.3** - マーカークラスタリング

### 状態管理・データ
- **React Context** - グローバル状態管理
- **localStorage** - ローカルデータ永続化
- **React Query** - サーバー状態管理

### 開発ツール
- **ESLint 9** - コード品質
- **Vitest** - テストフレームワーク
- **Prisma 5.12.0** - データベースORM

---

## 🚀 15. デプロイ・環境

### 必要環境
- **Node.js**: >=20.9.0
- **npm**: >=10.0.0

### ビルド
```bash
npm run build    # 本番ビルド
npm run start    # 本番サーバー起動
npm run dev      # 開発サーバー起動
```

### 環境変数
- データベース接続（Prisma）
- JWT シークレット

---

## 📈 16. パフォーマンス指標

### 最適化結果
- **初回レンダリング**: 60-70%高速化
- **localStorage アクセス**: 80%削減
- **DOM 要素数**: 98%削減（1800+ → 30）
- **バンドルサイズ**: 30-50KB削減
- **画像転送量**: 50-70%削減（WebP化後）

---

## 📝 17. 今後の展開（ロードマップ）

### 短期（1-3ヶ月）
- [ ] メジャー依存関係のアップグレード検討（React 19, Tailwind 4）
- [ ] ESLint 9 完全対応
- [ ] 画像の WebP/AVIF 化完了

### 中期（3-6ヶ月）
- [ ] データベース統合（店舗データの動的管理）
- [ ] 出店者向け管理画面
- [ ] リアルタイム在庫情報

### 長期（6ヶ月以上）
- [ ] ネイティブアプリ化（PWA → React Native）
- [ ] オフラインモード対応
- [ ] 多言語対応（日本語/英語）

---

**最終更新**: 2025年12月28日
**メンテナンス**: [GitHub Repository](https://github.com/Yutodesuy/nicchyo-platform)
